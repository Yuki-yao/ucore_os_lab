# Lab3 Report

姚宇奇(2015011351)	计55

## 练习1

### 实现思路

首先利用上次实验完成的get_pte()函数，根据mm提供的页目录基址和出错位置的虚拟地址查找页表项，并规定在页表不存在时新建一个页表。如果目标页帧不存在（此时页表项全为0），则在内存中分配一个新页并建立映射，这些操作通过调用函数pgdir_alloc_page()完成。

### 页目录项(PDE)和页表项(PTE)中的组成部分对ucore实现页替换算法的潜在用处

PDE和PTE的地址部分为各级表项之间的跳转提供了目标。页目录项的标志位在get_pte()函数中用来判断页表是否存在，页表项的标志位则在do_pgfault()中用来判断页帧是否存在。因此，页目录项中存储的页表信息为页替换提供了目标，页表项中存储的页帧信息则称为页替换时采用不同策略的依据。

### 如果ucore的缺页服务例程在执行过程中访问内存，出现了页访问异常，硬件需要做哪些事？

首先CPU将引发异常的线性地址装入寄存器CR2中，并将出错码存入中断栈中，以告知软件页访问异常的类型。之后中断服务例程执行do_pgfault()函数来进行软件上的异常处理。

##练习2

### 实现思路

这部分的内容涉及以下三个函数：do_pgfault(), _fifo_map_swappable(), _fifo_swap_out_victim()。以下分别进行说明。

#### do_pgfault()

代码实现是练习1的延续。在练习1中目标页帧存在的情况下，对应的情景是相应的物理页帧不在内存中，而是在swap分区或磁盘上。此时如果已经完成了交换分区的初始化，则调用swap_in()函数在内存中分配一个新页，并将磁盘中相应的内容读取到该页上。接着通过page_insert()函数为该页和给出的虚拟地址构建映射关系，再通过swap_map_swappable将该页设置为可交换状态，最后将虚拟地址存在该页的pra_vaddr成员中。

#### _fifo_map_swappable()

只需补充一行将最近加入的一页插到pra_list的头部（实际为pra_list_head的后一个元素）的代码`list_add(head, entry)`即可。

#### _fifo_swap_out_victim()

需要根据FIFO的原则选择最早进入列表的页准备换出。具体实现为通过定位到循环链表头部的前一项来确定最早加入的页，然后通过list_del()方法将该项从列表中移除，最后将ptr_page指针指向该页即可。

### 实现“extended clock 页替换算法”的设计方案

由于不同的页替换算法的区别只在于确定当前列表中应该被换出的页的方法，亦即swap_out_victim()实现方法的不同，因此现有的swap_manager框架足以支持在ucore中实现此算法。实现思路为在原有的链表上进行三次循环，每轮循环中都通过get_pte()函数获取每个页帧的页表项指针\*ptep，然后用`(*ptep & PTE_A)`和`(*ptep & PTE_D)`的方式检查该页表项的PTE_A和PTE_D标志位，来判断该页是否被访问过、是否被修改过。确定是否换出的原则如下：

1. 第一轮循环：第一个满足(PTE_A, PTE_D)=(0, 0)（以下简记为(x, y)的形式）的页被换出，函数返回；若不存在这样的页则进入第二轮循环；
2. 第二轮循环：第一个满足(0, 1)的页被换出，函数返回；若不存在这样的页则进入第三轮循环；
3. 第三轮循环：第一个满足PTE_D为0的页（即满足(1, 0)）被换出，函数返回；若不存在则进入第4步；
4. 所有页都为(1, 1)，此时按照FIFO的方式处理。

以上算法中具体换出操作与FIFO时没有区别。此外进行换入换出操作的时机也与FIFO相同，即需要调用的页不在页表中，而内存中又没有空闲空间，必须将页表中某一页置入外存的情况。

### 扩展练习Challenge

算法思想已在“实现extended clock 页替换算法的设计方案”中描述，并进行了代码实现。

## 与参考答案的区别

- do_pgfault()：我的实现中没有参考答案中输出的一些报错信息，并且对于page_insert()等函数的返回值也进行了额外的检查。
- _fifo_swap_out_victim()：我的实现没有进行head!=le和p!=NULL的asset断言。

## 知识点比较

### 练习1

实验知识点：页访问异常处理，ucore的虚拟内存管理的实现机制，虚拟内存相关的数据结构

OS知识点：虚拟页式存储，缺页异常处理

OS知识点较为宽泛地介绍了虚拟页式存储的基本原理和一些特点，本实验则要求学生对ucore自身的虚拟内存管理实现方式有较深的了解，明白page fault是ucore进行页面置换、实现虚拟内存的重要方式。同时，学生必须对之前实验中动手实现的页查找方法较为熟悉。

### 练习2

实验知识点：页置换的基本流程，FIFO页置换算法，swap_manager页面置换框架，可置换页面列表结构

OS知识点：虚拟存储中的页面交换，常见的页面置换算法与性能比较

OS知识点更强调对多个页面置换算法原理与性能层面的了解，而本实验侧重于实际动手实现一个可以运行的页置换算法，这要求学生对于底层的数据结构和算法比较熟悉。